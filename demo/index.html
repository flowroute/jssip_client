<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Flowroute JsSip Client</title>
  <meta name="description" content="Simple demonstration of Flowroute JsSip Client">
  <meta name="author" content="Mazuh">
</head>
<body>
  <select id="number">
    <option value="14503001085" selected>14503001085 (VoIP Patrol)</option>
    <option value="12012673228">12012673228 (Julien Mobile)</option>
    <option value="13125867146">13125867146 (FreeSwitch)</option>
  </select>
  <button id="call-btn" type="button" onclick="doCall()">Call</button>
  <br/>
  <br/>
  <label for="volume-range">Volume:<br/></label>
  <input value="100" id="volume-range" type="range" min="0" max="100" onchange="changeVolume(this.value)" />
  <br/>
  <br/>
  <label for="pheader-name">P-header name:</label>
  <input id="pheader-name" /><br/>
  <label for="pheader-value">P-header value:</label>
  <input id="pheader-value" /><br/>
  <button type="button" onclick="addPHeader()">Add</button>
  <button type="button" onclick="clearPHeaders()">Clear all</button>
  <br/>
  <br/>
  <textarea id="debug-console" rows="20" cols="30" readonly></textarea>
  <br/>
  <br/>

  <script src="./bundle.js"></script>
  <script>
    window.numberInput = document.getElementById('number');
    window.callBtn = document.getElementById('call-btn');
    window.debugConsole = document.getElementById('debug-console');
    window.volumeRange = document.getElementById('volume-range');
    window.pheaderName = document.getElementById('pheader-name');
    window.pheaderValue = document.getElementById('pheader-value');
    window.pheadersDisplayLine = document.getElementById('pheaders-display-line');

    window.flowrouteClient = new FlowrouteClient({
      debug: true,
      onUserAgentAction: handleUserAgentAction,
    });
    window.flowrouteClient.start();
    writeDebugLine('PO: ' + window.flowrouteClient.params.pointOfPresence);
    writeDebugLine('Caller ID: ' + window.flowrouteClient.params.callerId);

    function doCall() {
      window.flowrouteClient.call({
        to: window.numberInput.value,
        onCallAction: handleCallAction,
      });
    }

    function doHangup() {
      window.flowrouteClient.hangup();
    }

    function writeDebugLine(message) {
      window.debugConsole.value += message + '\n';
      window.debugConsole.scrollTop = debugConsole.scrollHeight;
    }
    
    function changeVolume(value) {
      window.flowrouteClient.setOutputVolume(value);
    }

    function addPHeader() {
      window.flowrouteClient.pushExtraPrivateCallHeader(pheaderName.value, pheaderValue.value);
      pheaderName.value = '';
      pheaderValue.value = '';
      writeDebugLine('Headers:\n' + (window.flowrouteClient.getExtraCallHeaders().length ? window.flowrouteClient.getExtraCallHeaders() : ['Empty']).join(', '));
    }

    function clearPHeaders() {
      while (window.flowrouteClient.getExtraCallHeaders().length) {
        window.flowrouteClient.getExtraCallHeaders().pop();
      }
      writeDebugLine('Headers:\n' + (window.flowrouteClient.getExtraCallHeaders().length ? window.flowrouteClient.getExtraCallHeaders() : ['Empty']).join(', '));
    }

    function handleUserAgentAction(action) {
      writeDebugLine('User agent action: ' + action.type);
    }

    function handleCallAction(action) {
      writeDebugLine('Call action: ' + action.type);
      switch (action.type) {
        case 'accepted':
        case 'confirmed':
          window.callBtn.innerText = 'Hangup';
          window.callBtn.onclick = doHangup;
          break;
        case 'ended':
          window.callBtn.innerText = 'Call';
          window.callBtn.onclick = doCall;
          break;
        default:
          console.warn('Ignored call state:', action.type, action.payload);
          break;
      }
    }
</script>
</body>
</html>
